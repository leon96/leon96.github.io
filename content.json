{"pages":[{"title":"about","text":"","link":"/about/index.html"},{"title":"tags","text":"","link":"/tags/index.html"},{"title":"categories","text":"","link":"/categories/index.html"}],"posts":[{"title":"CentOS切换Ubuntu中遇到的小坑","text":"故障出现 去年CentOS更改模式后，我们就开始尝试使用其他的系统，其中Ubuntu是个重点，开始把一些测试环境切换到Ubuntu。 某天突然接到告警，有服务挂了，登陆系统查看，发现所有的容器都被重启了。 问题排查 12345678910Oct 05 06:09:03 compute03 systemd[1]: Stopping containerd container runtime...Oct 05 06:09:03 compute03 containerd[57003]: time=&quot;2021-10-05T06:09:03.396688691Z&quot; level=info msg=&quot;Stop CRI service&quot;Oct 05 06:09:03 compute03 dockerd[234599]: time=&quot;2021-10-05T06:09:03.396773735Z&quot; level=error msg=&quot;Failed to get event&quot; error=&quot;rpc error: code = Unavailable desc = transport is closing&quot; module=libcontainerd namespace=mobyOct 05 06:09:03 compute03 dockerd[234599]: time=&quot;2021-10-05T06:09:03.396888091Z&quot; level=info msg=&quot;Waiting for containerd to be ready to restart event processing&quot; module=libcontainerd namespace=mobyOct 05 06:09:03 compute03 dockerd[234599]: time=&quot;2021-10-05T06:09:03.396874439Z&quot; level=error msg=&quot;Failed to get event&quot; error=&quot;rpc error: code = Unavailable desc = transport is closing&quot; module=libcontainerd namespace=plugins.mobyOct 05 06:09:03 compute03 dockerd[234599]: time=&quot;2021-10-05T06:09:03.397036720Z&quot; level=info msg=&quot;Waiting for containerd to be ready to restart event processing&quot; module=libcontainerd namespace=plugins.mobyOct 05 06:09:03 compute03 containerd[57003]: time=&quot;2021-10-05T06:09:03.410846169Z&quot; level=info msg=&quot;Stop CRI service&quot;Oct 05 06:09:03 compute03 containerd[57003]: time=&quot;2021-10-05T06:09:03.411083167Z&quot; level=info msg=&quot;Event monitor stopped&quot;Oct 05 06:09:03 compute03 containerd[57003]: time=&quot;2021-10-05T06:09:03.411120540Z&quot; level=info msg=&quot;Stream server stopped&quot;Oct 05 06:09:03 compute03 systemd[1]: containerd.service: Succeeded. 系统日志里看到containerd服务关闭的日志，同时看到有一条apt更新的日志 1Oct 05 06:08:24 compute03 systemd[1]: Starting Daily apt upgrade and clean activities... 于是怀疑是不是软件更新导致服务重启，查看apt日志，果然找到了,在/var/log/apt/history.log中发现更新了docker.io和containerd。 1234567891011121314Start-Date: 2021-10-05 06:08:59Commandline: /usr/bin/unattended-upgradeUpgrade: libpython3.8-minimal:amd64 (3.8.10-0ubuntu1~20.04, 3.8.10-0ubuntu1~20.04.1), libpython3.8:amd64 (3.8.10-0ubuntu1~20.04, 3.8.10-0ubuntu1~20.04.1), python3.8:amd64 (3.8.10-0ubuntu1~20.04, 3.8.10-0ubuntu1~20.04.1), python3.8-minimal:amd64 (3.8.10-0ubuntu1~20.04, 3.8.10-0ubuntu1~20.04.1), libpython3.8-stdlib:amd64 (3.8.10-0ubuntu1~20.04, 3.8.10-0ubuntu1~20.04.1)End-Date: 2021-10-05 06:09:01Start-Date: 2021-10-05 06:09:03Commandline: /usr/bin/unattended-upgradeUpgrade: containerd:amd64 (1.5.2-0ubuntu1~20.04.2, 1.5.2-0ubuntu1~20.04.3)End-Date: 2021-10-05 06:09:07Start-Date: 2021-10-05 06:09:08Commandline: /usr/bin/unattended-upgradeUpgrade: docker.io:amd64 (20.10.7-0ubuntu1~20.04.1, 20.10.7-0ubuntu1~20.04.2)End-Date: 2021-10-05 06:09:22 查了一下Debian/Ubuntu系统更新机制，Ubuntu通过apt-daily执行unattended-upgrades来自动安装更新，配置文件为： /etc/apt/apt.conf.d/50unattended-upgrades 内容如下： 123456789Unattended-Upgrade::Allowed-Origins { &quot;${distro_id}:${distro_codename}&quot;; &quot;${distro_id}:${distro_codename}-security&quot;; &quot;${distro_id}ESMApps:${distro_codename}-apps-security&quot;; &quot;${distro_id}ESM:${distro_codename}-infra-security&quot;;};Unattended-Upgrade::Package-Blacklist {};Unattended-Upgrade::DevRelease &quot;auto&quot;; Ubuntu默认会安装Allow-Origins里的更新，我在其中一个security里找到了这次事件的更新包。 后续问题处理 后续问题处理有三种方法来关闭自动更新。 修改/etc/apt/apt.conf.d/20auto-upgrades文件，把值都改为0 修改/etc/apt/apt.conf.d/50unattended-upgrades文件，把不需要更新的源去掉。 禁用apt-daily服务","link":"/2021/10/12/CentOS%E5%88%87%E6%8D%A2Ubuntu%E4%B8%AD%E9%81%87%E5%88%B0%E7%9A%84%E5%B0%8F%E5%9D%91/"},{"title":"腾讯云COS静态网站网页访问提示下载问题排查","text":"起因 最近前端想把腾讯云nginx上的静态网站切换到腾讯云COS，建桶上传文件，打开页面就提示下载文件。 问题处理 网上查到很多人遇到这个问题，在CDN里加一个HTTP Header解决了，于是操作之。 兴冲冲打开页面，结果还是提示下载文件，这下没有了头绪。 一通排查，后来通过curl -I查看URL返回的头，发现了问题 12345678910HTTP/2 200last-modified: Wed, 15 Sep 2021 15:40:03 GMTserver: tencent-cosdate: Thu, 16 Sep 2021 08:15:11 GMTcontent-type: application/octet-streamx-daa-tunnel: hop_count=2cache-control: max-age=600content-length: 4573accept-ranges: bytescontent-disposition: inline 返回的头部中content-type竟然是application/octet-stream。 于是去COS页面查看文件属性，结果： application/octet-stream在RFC 2046[1]中这样定义的： 12The &quot;octet-stream&quot; subtype is used to indicate that a body contains arbitrary binary data. 任意二进制数据文件，通常只用于文件下载时使用，把该header删除，再访问，这下可以在页面中打开了。 问上传文件的开发，他使用的第三方工具上传的，经检查，所有的文件都加的一样的Header, content-type=application/octet-stream。 删除所有文件，改用腾讯云自身的工具后检查文件信息，不同类型的加上的是各自对应的Header。 访问一切正常，问题搞定。 RFC 2046 ↩︎","link":"/2021/09/16/%E8%85%BE%E8%AE%AF%E4%BA%91COS%E9%9D%99%E6%80%81%E7%BD%91%E7%AB%99%E7%BD%91%E9%A1%B5%E8%AE%BF%E9%97%AE%E6%8F%90%E7%A4%BA%E4%B8%8B%E8%BD%BD%E9%97%AE%E9%A2%98%E6%8E%92%E6%9F%A5/"}],"tags":[{"name":"Ubuntu","slug":"Ubuntu","link":"/tags/Ubuntu/"},{"name":"腾讯云","slug":"腾讯云","link":"/tags/%E8%85%BE%E8%AE%AF%E4%BA%91/"}],"categories":[{"name":"问题排查","slug":"问题排查","link":"/categories/%E9%97%AE%E9%A2%98%E6%8E%92%E6%9F%A5/"}]}